!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define("nesEmulator",[],i):"object"==typeof exports?exports.nesEmulator=i():t.nesEmulator=i()}(this,function(){return function(t){function i(e){if(s[e])return s[e].exports;var r=s[e]={exports:{},id:e,loaded:!1};return t[e].call(r.exports,r,r.exports,i),r.loaded=!0,r.exports}var s={};return i.m=t,i.c=s,i.p="/js/",i(0)}([function(t,i,s){t.exports={NES:s(1)}},function(t,i,s){var e=s(2),r=s(3),n=function(t){this.ines=null,this.load(t),console.log(this),this.cpu=new r(this)};n.prototype={load:function(t){this.ines=new e,this.ines.load(t)}},t.exports=n},function(t,i){var s=function(){this.rpgRom=null,this.chrRom=null,this.numRam=null,this.sram=new Array(8192),this.mapperType=null,this.mirroring=null,this.batteryRam=null};s.prototype={HORIZONTAL_MIRRORING:0,VERTICAL_MIRRORING:1,FOURSCREEN_MIRRORING:2,load:function(t){this.data=t;for(var i=new Array(16),s=0;s<16;s++)i[s]=255&t.charCodeAt(s);if(78!==i[0]||69!==i[1]||83!==i[2]||26!==i[3])throw new Error("Not a valid iNES file.");var e=i[4],r=i[5],n=i[6];this.mirroring=1&n,8&n&&(this.mirroring=this.FOURSCREEN_MIRRORING),this.batteryRam=0!==(2&n);var h=i[7];this.mapperType=240&h|n>>4;for(var s=(i[8],9);s<16;s++)if(0!==i[s])throw new Error("Reserved for future usage and should all be 0.");this.rpgRom=new Array(e);for(var o=16,s=0;s<e;s++){this.rpgRom[s]=new Array(16384);for(var a=0;a<16384&&!(o+a>=t.length);a++)this.rpgRom[s][a]=255&t.charCodeAt(o+a);o+=16384}for(this.chrRom=new Array(r),s=0;s<r;s++){for(this.chrRom[s]=new Array(4096),a=0;a<4096&&!(o+a>=t.length);a++)this.chrRom[s][a]=255&t.charCodeAt(o+a);o+=4096}}},t.exports=s},function(module,exports,__webpack_require__){const modeAbsolute=1,modeAbsoluteX=2,modeAbsoluteY=3,modeAccumulator=4,modeImmediate=5,modeImplied=6,modeIndexedIndirect=7,modeIndirect=8,modeIndirectIndexed=9,modeRelative=10,modeZeroPage=11,modeZeroPageX=12,modeZeroPageY=13;var instructionModes=[6,7,6,7,11,11,11,11,6,5,4,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,1,7,6,7,11,11,11,11,6,5,4,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,6,7,6,7,11,11,11,11,6,5,4,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,6,7,6,7,11,11,11,11,6,5,4,5,8,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,5,7,5,7,11,11,11,11,6,5,6,5,1,1,1,1,10,9,6,9,12,12,13,13,6,3,6,3,2,2,3,3,5,7,5,7,11,11,11,11,6,5,6,5,1,1,1,1,10,9,6,9,12,12,13,13,6,3,6,3,2,2,3,3,5,7,5,7,11,11,11,11,6,5,6,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2,5,7,5,7,11,11,11,11,6,5,6,5,1,1,1,1,10,9,6,9,12,12,12,12,6,3,6,3,2,2,2,2],instructionSizes=[1,2,0,0,2,2,2,0,1,2,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,3,1,0,3,3,3,0,3,2,0,0,2,2,2,0,1,2,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,3,1,0,3,3,3,0,1,2,0,0,2,2,2,0,1,2,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,3,1,0,3,3,3,0,1,2,0,0,2,2,2,0,1,2,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,3,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,0,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,3,1,0,0,3,0,0,2,2,2,0,2,2,2,0,1,2,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,3,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,2,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,3,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,2,1,0,3,3,3,0,2,2,0,0,2,2,2,0,1,3,1,0,3,3,3,0],instructioncycles=[7,6,2,8,3,3,5,5,3,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,3,2,2,2,3,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,5,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,6,2,6,4,4,4,4,2,5,2,5,5,5,5,5,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,5,2,5,4,4,4,4,2,4,2,4,4,4,4,4,2,6,2,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,2,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7],instructionPagecycles=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,0,0,0,0,0,1,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,1,1,0,0],instructionNames=["BRK","ORA","KIL","SLO","NOP","ORA","ASL","SLO","PHP","ORA","ASL","ANC","NOP","ORA","ASL","SLO","BPL","ORA","KIL","SLO","NOP","ORA","ASL","SLO","CLC","ORA","NOP","SLO","NOP","ORA","ASL","SLO","JSR","AND","KIL","RLA","BIT","AND","ROL","RLA","PLP","AND","ROL","ANC","BIT","AND","ROL","RLA","BMI","AND","KIL","RLA","NOP","AND","ROL","RLA","SEC","AND","NOP","RLA","NOP","AND","ROL","RLA","RTI","EOR","KIL","SRE","NOP","EOR","LSR","SRE","PHA","EOR","LSR","ALR","JMP","EOR","LSR","SRE","BVC","EOR","KIL","SRE","NOP","EOR","LSR","SRE","CLI","EOR","NOP","SRE","NOP","EOR","LSR","SRE","RTS","ADC","KIL","RRA","NOP","ADC","ROR","RRA","PLA","ADC","ROR","ARR","JMP","ADC","ROR","RRA","BVS","ADC","KIL","RRA","NOP","ADC","ROR","RRA","SEI","ADC","NOP","RRA","NOP","ADC","ROR","RRA","NOP","STA","NOP","SAX","STY","STA","STX","SAX","DEY","NOP","TXA","XAA","STY","STA","STX","SAX","BCC","STA","KIL","AHX","STY","STA","STX","SAX","TYA","STA","TXS","TAS","SHY","STA","SHX","AHX","LDY","LDA","LDX","LAX","LDY","LDA","LDX","LAX","TAY","LDA","TAX","LAX","LDY","LDA","LDX","LAX","BCS","LDA","KIL","LAX","LDY","LDA","LDX","LAX","CLV","LDA","TSX","LAS","LDY","LDA","LDX","LAX","CPY","CMP","NOP","DCP","CPY","CMP","DEC","DCP","INY","CMP","DEX","AXS","CPY","CMP","DEC","DCP","BNE","CMP","KIL","DCP","NOP","CMP","DEC","DCP","CLD","CMP","NOP","DCP","NOP","CMP","DEC","DCP","CPX","SBC","NOP","ISC","CPX","SBC","INC","ISC","INX","SBC","NOP","SBC","CPX","SBC","INC","ISC","BEQ","SBC","KIL","ISC","NOP","SBC","INC","ISC","SED","SBC","NOP","ISC","NOP","SBC","INC","ISC"];const CPUFrequency=1789773,interruptNone=0,interruptNMI=1,interruptIRQ=2,interruptRESET=3;var CPU=function(t){this.nes=t,this.ram=new Array(2048),this.cycles=null,this.stall=null,this.A=0,this.X=0,this.Y=0,this.SP=null,this.N=null,this.V=null,this.U=null,this.B=null,this.D=null,this.I=null,this.Z=null,this.C=null,this.reset()},util=__webpack_require__(4);CPU.prototype={reset:function(){this.PC=this.read16(65532),this.SP=253,this.setFlags(36),this.interrupt=interruptNone},printInstruction:function(){var t=this.read(this.PC),i=instructionSizes[t],s=instructionNames[t],e=this.read(this.PC+0).toString(16),r="  ",n="  ";return i>1&&(r=this.read(this.PC+1).toString(16)),i>2&&(n=this.read(this.PC+2).toString(16)),console.log(this.PC,e,r,n,s,"",this.A,this.X,this.Y,this.flags(),this.SP,3*this.cycles%341),util.sprintf("%4X  %02s %02s %02s  %s %28sA:%02X X:%02X Y:%02X P:%02X SP:%02X CYC:%3d\n",this.PC,e,r,n,s,"",this.A,this.X,this.Y,this.flags(),this.SP,3*this.cycles%341)},step:function(){if(this.stall>0)return this.stall--,1;var cycles=this.cycles;switch(this.interrupt){case interruptIRQ:this.irq();case interruptNMI:this.nmi()}this.interrupt=interruptNone;var opcode=this.read(this.PC),mode=instructionModes[opcode],address=null,pageCrossed=null;switch(mode){case modeAbsolute:address=this.read16(this.PC+1);break;case modeAbsoluteX:address=this.read16(this.PC+1)+this.X,pageCrossed=this.pagesDiffer(address-this.X,address);break;case modeAbsoluteY:address=this.read16(this.PC+1)+this.Y,pageCrossed=this.pagesDiffer(address-this.Y,address);break;case modeAccumulator:address=0;break;case modeImmediate:address=this.PC+1;break;case modeImplied:address=0;break;case modeIndexedIndirect:address=this.read16(this.read(this.PC+1)+this.X);break;case modeIndirect:address=this.read16(this.read16(this.PC+1));break;case modeIndirectIndexed:address=this.read16bug(this.read(this.PC+1))+this.Y,pageCrossed=this.pagesDiffer(address-this.Y,address);break;case modeRelative:var offset=this.read(this.PC+1);address=offset<128?this.PC+2+offset:this.PC+2+offset-256;break;case modeZeroPage:address=this.read(this.PC+1);break;case modeZeroPageX:address=this.read(this.PC+1)+this.X&255;break;case modeZeroPageY:address=this.read(this.PC+1)+this.Y&255}return this.PC+=instructionSizes[opcode],this.cycles+=instructioncycles[opcode],pageCrossed&&(this.cycles+=instructionPagecycles[opcode]),console.log(instructionNames[opcode],address,mode),eval("this."+instructionNames[opcode]+"(address, this.PC, mode)"),this.cycles-cycles},triggerNMI:function(){this.interrupt=interruptNMI},triggerIRQ:function(){0===this.I&&(this.interrupt=interruptIRQ)},nmi:function(){this.push16(this.PC),this.PHP(null),this.PC=this.read16(65530),this.I=1,this.cycles+=7},irq:function(){this.push16(this.PC),this.PHP(null),this.PC=this.read16(65534),this.I=1,this.cycles+=7},flags:function(){return this.N<<7|this.V<<6|this.U<<5|this.B<<4|this.D<<3|this.I<<2|this.Z<<1|this.C<<0},setFlags:function(t){this.C=t>>0&1,this.Z=t>>1&1,this.I=t>>2&1,this.D=t>>3&1,this.B=t>>4&1,this.U=t>>5&1,this.V=t>>6&1,this.N=t>>7&1},setZ:function(t){t&=255,this.Z=0===t?1:0},setN:function(t){t&=255,this.N=0!==(128&t)?1:0},setZN:function(t){this.setZ(t),this.setN(t)},pagesDiffer:function(t,i){return t&65280!==i&65280},read:function(t){if(t<8192)return this.nes.ines.chrRom[0][t];if(t>=49152)return 1===this.nes.ines.rpgRom.length?this.nes.ines.rpgRom[0][t-49152]:this.nes.ines.rpgRom[1][t-49152];if(t>=32768)return console.log("read:",t.toString(16)),this.nes.ines.rpgRom[0][t-32768];if(t>=24576)return this.nes.ines.sram[t-24576];throw new Error("unhandled mapper2 read at address: "+t.toString(16))},write:function(t,i){if(t<8192)return void(this.nes.ines.chrRom[0][t]=i);if(t>=49152)return void(1===this.nes.ines.rpgRom.length?this.nes.ines.rpgRom[0][t-49152]=i:this.nes.ines.rpgRom[1][t-49152]=i);if(t>=32768)return console.log("write",t.toString(16),i.toString(16)),void(this.nes.ines.rpgRom[0][t-32768]=i);if(t>=24576)return void(this.nes.ines.sram[t-24576]=i);throw new Error("unhandled mapper2 write at address: "+t.toString(16))},read16:function(t){var i=this.read(t),s=this.read(t+1);return(255&s)<<8|255&i},read16bug:function(t){var i=t,s=65280&i|256&i&65535,e=this.read(i),r=this.read(s);return(255&r)<<8|255&e},push:function(t){this.write(256|this.SP,t),this.SP--},pull:function(){return this.SP++,this.read(256|this.SP)},push16:function(t){var i=t>>8&255,s=255&t;this.push(i),this.push(s)},pull16:function(){var t=this.pull(),i=this.pull();return(255&i)<<8|255&t},ADC:function(t,i,s){var e=this.A,r=this.read(t),n=this.C;this.A=e+r+n&255,this.setZN(this.A),this.C=e+r+n>255?1:0,0===(128&(e^r))&&0!==(128&(e^this.A))?this.V=1:this.V=0},AND:function(t,i,s){this.A=this.A&this.read(t),this.setZN(this.A)},ASL:function(t,i,s){if(s===modeAccumulator)this.C=this.A>>7&1,this.A=this.A<<1&255,this.setZN(this.A);else{var e=this.read(t);this.C=e>>7&1,e=e<<1&255,this.write(t,e),this.setZN(e)}},addBranchCycles:function(t,i){this.cycles++,this.pagesDiffer(i,t)&&this.cycles++},BCC:function(t,i,s){0===this.C&&(this.PC=t,this.addBranchCycles(t,i))},BCS:function(t,i,s){0!==this.C&&(this.PC=t,this.addBranchCycles(t,i))},BEQ:function(t,i,s){0!==this.Z&&(this.PC=t,this.addBranchCycles(t,i))},BIT:function(t,i,s){var e=this.read(t);this.V=e>>6&1,this.setZ(e&this.A),this.setN(e)},BMI:function(t,i,s){0!==this.N&&(this.PC=t,this.addBranchCycles(t,i))},BNE:function(t,i,s){0===this.Z&&(this.PC=t,this.addBranchCycles(t,i))},BPL:function(t,i,s){0===this.N&&(this.PC=t,this.addBranchCycles(t,i))},BRK:function(t,i,s){this.push16(this.PC),this.PHP(t,i,s),this.SEI(t,i,s),this.PC=this.read16(65534)},BVC:function(t,i,s){0===this.V&&(this.PC=t,this.addBranchCycles(t,i))},BVS:function(t,i,s){0!==this.V&&(this.PC=t,this.addBranchCycles(t,i))},CLC:function(t,i,s){this.C=0},CLD:function(t,i,s){this.D=0},CLI:function(t,i,s){this.I=0},CLV:function(t,i,s){this.V=0},compare:function(t,i){this.setZN(t-i),this.C=t>=i?1:0},CMP:function(t,i,s){var e=this.read(t);this.compare(this.A,e)},CPX:function(t,i,s){var e=this.read(t);this.compare(this.X,e)},CPY:function(t,i,s){var e=this.read(t);this.compare(this.Y,e)},DEC:function(t,i,s){var e=this.read(t)-1;this.write(t,e),this.setZN(e)},DEX:function(t,i,s){this.X=this.X-1&255,this.setZN(this.X)},DEY:function(t,i,s){this.Y=this.Y-1&255,this.setZN(this.Y)},EOR:function(t,i,s){this.A=this.A^this.read(t),this.setZN(this.A)},INC:function(t,i,s){var e=this.read(t)+1;this.write(t,e),this.setZN(e)},INX:function(t,i,s){this.X=this.X+1&255,this.setZN(this.X)},INY:function(t,i,s){this.Y=this.Y+1&255,this.setZN(this.Y)},JMP:function(t,i,s){this.PC=t},JSR:function(t,i,s){this.push16(this.PC-1),this.PC=t},LDA:function(t,i,s){console.log("LDA",this.A,t),this.A=this.read(t),this.setZN(this.A)},LDX:function(t,i,s){this.X=this.read(t),this.setZN(this.X)},LDY:function(t,i,s){this.Y=this.read(t),this.setZN(this.Y)},LSR:function(t,i,s){if(s===modeAccumulator)this.C=1&this.A,this.A>>=1,this.setZN(this.A);else{var e=this.read(t);this.C=1&e,e>>=1,this.write(t,e),this.setZN(e)}},NOP:function(t,i,s){},ORA:function(t,i,s){this.A=this.A|this.read(t),this.setZN(this.A)},PHA:function(t,i,s){this.push(this.A)},PHP:function(t,i,s){this.push(16|this.flags())},PLA:function(t,i,s){this.A=this.pull(),this.setZN(this.A)},PLP:function(t,i,s){this.setFlags(239&this.pull()|32)},ROL:function(t,i,s){var e=this.C;if(s===modeAccumulator)this.C=this.A>>7&1,this.A=255&(this.A<<1|e),this.setZN(this.A);else{var r=this.read(t);this.C=r>>7&1,r=255&(r<<1|e),this.write(t,r),this.setZN(r)}},ROR:function(t,i,s){var e=this.C;if(s===modeAccumulator)this.C=1&this.A,this.A=255&(this.A>>1|e<<7),this.setZN(this.A);else{var r=this.read(t);this.C=1&r,r=255&(r>>1|e<<7),this.write(t,r),this.setZN(r)}},RTI:function(t,i,s){this.setFlags(239&this.pull()|32),this.PC=this.pull16()},RTS:function(t,i,s){this.PC=this.pull16()+1},SBC:function(t,i,s){var e=this.A,r=this.read(t),n=this.C;this.A=e-r-(1-n)&255,this.setZN(this.A),e-r-(1-n)>=0?this.C=1:this.C=0,0!==(128&(e^r))&&0!==(128&(e^this.A))?this.V=1:this.V=0},SEC:function(t,i,s){this.C=1},SED:function(t,i,s){this.D=1},SEI:function(t,i,s){this.I=1},STA:function(t,i,s){this.write(t,this.A)},STX:function(t,i,s){this.write(t,this.X)},STY:function(t,i,s){this.write(t,this.Y)},TAX:function(t,i,s){this.X=this.A,this.setZN(this.X)},TAY:function(t,i,s){this.Y=this.A,this.setZN(this.Y)},TSX:function(t,i,s){this.X=this.SP,this.setZN(this.X)},TXA:function(t,i,s){this.A=this.X,this.setZN(this.A)},TXS:function(t,i,s){this.SP=this.X},TYA:function(t,i,s){this.A=this.Y,this.setZN(this.A)},AHX:function(t,i,s){throw new Error("illegal instruction")},ALR:function(t,i,s){throw new Error("illegal instruction")},ANC:function(t,i,s){throw new Error("illegal instruction")},ARR:function(t,i,s){throw new Error("illegal instruction")},AXS:function(t,i,s){throw new Error("illegal instruction")},DCP:function(t,i,s){throw new Error("illegal instruction")},ISC:function(t,i,s){throw new Error("illegal instruction")},KIL:function(t,i,s){throw new Error("illegal instruction")},LAS:function(t,i,s){throw new Error("illegal instruction")},LAX:function(t,i,s){throw new Error("illegal instruction")},RLA:function(t,i,s){throw new Error("illegal instruction")},RRA:function(t,i,s){throw new Error("illegal instruction")},SAX:function(t,i,s){throw new Error("illegal instruction")},SHX:function(t,i,s){throw new Error("illegal instruction")},SHY:function(t,i,s){throw new Error("illegal instruction")},SLO:function(t,i,s){throw new Error("illegal instruction")},SRE:function(t,i,s){throw new Error("illegal instruction")},TAS:function(t,i,s){throw new Error("illegal instruction")},XAA:function(t,i,s){throw new Error("illegal instruction")}},module.exports=CPU},function(t,i){function s(t,i){for(var s=[];i>0;s[--i]=t);return s.join("")}i.sprintf=function(){for(var t,i,e,r,n,h=0,o=arguments[h++],a=[],c="";o;){if(i=/^[^\x25]+/.exec(o))a.push(i[0]);else if(i=/^\x25{2}/.exec(o))a.push("%");else{if(!(i=/^\x25(?:(\d+)\$)?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(o)))throw"Huh ?!";if(null==(t=arguments[i[1]||h++])||void 0==t)throw"Too few arguments.";if(/[^s]/.test(i[7])&&"number"!=typeof t)throw"Expecting number but found "+typeof t;switch(i[7]){case"b":t=t.toString(2);break;case"c":t=String.fromCharCode(t);break;case"d":t=parseInt(t);break;case"e":t=i[6]?t.toExponential(i[6]):t.toExponential();break;case"f":t=i[6]?parseFloat(t).toFixed(i[6]):parseFloat(t);break;case"o":t=t.toString(8);break;case"s":t=(t=String(t))&&i[6]?t.substring(0,i[6]):t;break;case"u":t=Math.abs(t);break;case"x":t=t.toString(16);break;case"X":t=t.toString(16).toUpperCase()}t=/[def]/.test(i[7])&&i[2]&&t>=0?"+"+t:t,r=i[3]?"0"==i[3]?"0":i[3].charAt(1):" ",n=i[5]-String(t).length-c.length,e=i[5]?s(r,n):"",a.push(c+(i[4]?t+e:e+t))}o=o.substring(i[0].length)}return a.join("")}}])});