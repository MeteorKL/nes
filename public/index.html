<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>nes emulator</title>
    <link rel="stylesheet" type="text/css" href="css/mystyle.css">
    <script type="text/javascript" charset="utf-8" src="js/nes.js"></script>
</head>
<body>
<div id="nesFileDrag" style="float: left;height: 400px;width: 400px;background-color: cornflowerblue;">
    <input type="file" id="nesFileChoose" style="height: 400px;width: 400px;opacity: 0;" onchange="chooseFile()"/>
    <div id="nesFileStatus" style="position: absolute;left: 0;top: 180px;width: 400px;text-align: center;">Choose Or
        Drag a File Here
    </div>
</div>
<div style="float: right">
    <button onclick="step()">next</button>
    <textarea id="result"></textarea>
</div>
</body>
<script>
    var nesFileDrag = document.getElementById("nesFileDrag");
    var nesFileChoose = document.getElementById("nesFileChoose");
    var nesFileStatus = document.getElementById("nesFileStatus");

    function chooseFile(ev) {
        if (nesFileChoose.files && nesFileChoose.files[0]) {
            var file = nesFileChoose.files[0];
            loadROM(file);
        }
    }

    nesFileDrag.addEventListener("dragenter", function (ev) {
        ev.preventDefault();
    });
    nesFileDrag.addEventListener("dragover", function (ev) {
        ev.preventDefault();
    });
    nesFileDrag.addEventListener("dragleave", function (ev) {
        ev.preventDefault();
    });
    nesFileDrag.addEventListener("drop", function (ev) {
        ev.preventDefault();
        var file = ev.dataTransfer.files[0];
        loadROM(file);
    }, false);

    var nes = null;

    function loadROM(file) {
        nesFileStatus.innerText = file.name;

        if (file.size === 0) {
            return
        }
        var reader = new FileReader();
        reader.onload = function () {
            nes = new nesEmulator.NES(this.result);
            // nes.cpu.PC = 0xC000;
            console.log(nes);
            var result = '';
            for (var i = 0; i < 8991; i++) {
                console.log("--------------------------------------------------------");
                var info = nes.cpu.printInstruction();
                console.log(i+1, info);
                result += info;
                document.getElementById("result").innerText = result;
                nes.cpu.step();
            }
            document.getElementById("result").innerText = result;
            // for (var i=0;i<8991;i++) {
            //     nes.cpu.step();
            //     nes.cpu.printInstruction();
            // }
            // if (nes.cpu.read(0x6000) < 0x80) {
            //     console.log(nes.cpu.cycles);
            // }
            // console.log(nes.cpu.read(0x6004));
        };
        reader.readAsBinaryString(file);
    }

    function step(ev) {
        nes.cpu.printInstruction();
        nes.cpu.step();
    }
</script>
</html>